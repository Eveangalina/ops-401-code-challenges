#!/usr/bin/env python3
# Script Name:                  Ops Challenge: Signature-based Malware Detection Part 3 of 3
# Author:                       E.Campos
# Date of latest revision:      02/21/2024
# Purpose:                      Malware detection using file hashing and VirusTotal.
# Resources: Classmates; Rodolfo Gonzalez / Juan Cano / chat.openai.com

import os
import hashlib
import requests

# Function to calculate the MD5 hash of a file.
def hash_file(filename):
    print(f"Hashing file: {filename}")
    h = hashlib.md5()
    try:
        with open(filename, 'rb') as file:
            chunk = 0
            while chunk != b'':
                chunk = file.read(1024)
                h.update(chunk)
    except IOError as e:
        print(f"Error opening file: {e}")
        return None
    return h.hexdigest()

# Function to check the file hash with VirusTotal.
def check_virustotal(file_hash):
    print(f"Checking hash with VirusTotal: {file_hash}")
    apikey = os.getenv('API_KEY_VIRUSTOTAL')
    if not apikey:
        print("API key for VirusTotal is not set.")
        return
    query = f'python3 virustotal-search.py -k {apikey} -m {file_hash}'
    os.system(query)

# Function to search for a specific file in a directory and subdirectories.
def search_file(file_name, directory):
    print(f"Searching for '{file_name}' in '{directory}'...")
    hits = 0
    files_searched = 0

    if not os.path.isdir(directory):
        print("Error: Invalid directory path.")
        return 0, 0

    for root, dirs, files in os.walk(directory):
        for file in files:
            if file == file_name:
                hits += 1
                file_path = os.path.join(root, file)
                print(f"Found: {file_path}")
                file_hash = hash_file(file_path)
                if file_hash and input("Check this file hash with VirusTotal? (y/n): ").strip().lower() == 'y':
                    check_virustotal(file_hash)
            files_searched += 1
            print_progress(files_searched)

    print(f"Search completed. {hits} hits found after searching {files_searched} files.")
    return hits, files_searched

# Function to print the number of files searched.
def print_progress(files_searched):
    print(f"Files searched: {files_searched}", end='\r')

# Function to list all directories in the root.
def list_directories():
    print("Listing directories...")
    current_directory = os.getcwd()
    for item in os.listdir("/"):
        item_path = os.path.join("/", item)
        if os.path.isdir(item_path):
            print(f"- {item_path} {'(Current Directory)' if item_path == current_directory else ''}")
    print("Directory listing complete.")

# Function to handle user input for searching files.
def search_files():
    print("Please provide the file name and directory to search.")
    file_name = input("Enter the file name to search for: ").strip()
    directory = input("Enter the directory to search in or type 'list' to see available directories: ").strip()

    if directory.lower() == "list":
        list_directories()
    elif not file_name or not directory:
        print("File name or directory was not provided. Please try again.")
    elif not os.path.exists(directory):
        print("Error: Directory does not exist.")
    else:
        search_file(file_name, directory)

# Main function to drive the script and provide a menu for the user.
def main():
    print("Welcome to the malware detection script. Please select an option.")
    while True:
        print("1. Search for files")
        print("2. List available directories")
        print("3. Exit")
        choice = input("Enter your choice: ").strip()

        if choice == "1":
            search_files()
        elif choice == "2":
            list_directories()
        elif choice == "3":
            print("Exiting the program.")
            break
        else:
            print("Invalid choice. Please enter 1, 2, or 3.")

if __name__ == "__main__":
    main()
